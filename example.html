<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Live input record and playback</title>
  <script src="recorder.js"></script>
  <style type='text/css'>
    ul { list-style: none; }
    li { margin: 1em; }
    audio { display: block; }
  </style>
</head>
<body>

  <h1>Recorder.js simple example</h1>
  <p>Before you enable monitoring, make sure to either plug in headphones or turn the volume down.</p>
  <p>This ogg opus implementation does not support more than 2 channels.</p>
  <p>If recording with opus encoding, then sampleRate and bitDepth values will be forced to 16bit and 48000Hz.</p>

  <h2>Options</h2>

  <div>
    <label>enableMonitoring</label>
    <input type="checkbox" id="enableMonitoring"/>
  </div>

  <div>
    <label>bitDepth</label>
    <select id="bitDepth">
      <option value="8">8</option> 
      <option value="16" selected>16</option>
      <option value="24">24</option>
      <option value="32">32</option>
    </select>
  </div>

  <div>
    <label>disableFilter</label>
    <input type="checkbox" id="disableFilter"/>
  </div>

  <div>
    <label>numberOfChannels</label>
    <input id="numberOfChannels" type="number" value="1" />
  </div>

  <div>
    <label>recordOpus</label>
    <input type="checkbox" id="recordOpus" checked/>
  </div>

  <div>
    <label>sampleRate</label>
    <input id="sampleRate" type="number" value="44100" />
  </div>

  <h2>Commands</h2>
  <button id="init">init</button>
  <button id="start" disabled>record</button>
  <button id="pause" disabled>pause</button>
  <button id="reset" disabled>reset</button>
  <button id="done" disabled>done</button>
  
  <h2>Recordings</h2>
  <ul id="recordingslist"></ul>
  
  <h2>Log</h2>
  <pre id="log"></pre>

  <script>
    var recorder;

    init.addEventListener( "click", function(){

      screenLogger('Initializing');

      init.disabled = true;
      start.disabled = false;
      pause.disabled = false;
      reset.disabled = false;
      done.disabled = false;

      recorder = new Recorder({
        enableMonitoring: enableMonitoring.checked,
        numberOfChannels: numberOfChannels.value,
        bitDepth: bitDepth.options[ bitDepth.selectedIndex ].value,
        recordOpus: recordOpus.checked,
        sampleRate: sampleRate.value,
        disableFilter: disableFilter.checked
      });

      start.addEventListener("click", function(){ recorder.startRecording(); });
      pause.addEventListener("click", function(){ recorder.pauseRecording(); });
      reset.addEventListener("click", function(){ recorder.reset(); });
      done.addEventListener("click", doneRecording );

      recorder.addEventListener( "stateChange", function(e){
        screenLogger('Recorder is in state ' + e.detail);
      });

      recorder.addEventListener( "recordingTimeChange", function(e){
        screenLogger('Recorded ' + e.detail + ' seconds');
      });
    });

    function doneRecording() {
      var date = new Date().toISOString();
      recorder.doneRecording();
      start.disabled = true;
      pause.disabled = true;
      done.disabled = true;
      reset.disabled = true;
      init.disabled = false;

      recorder.getWav( function( wavBlob ) {
        if ( wavBlob ) createDownloadLink( wavBlob, date+'.wav' );
      });

      recorder.getOgg( function( oggBlob ) {
        if ( oggBlob ) createDownloadLink( oggBlob, date+'.ogg' );
      });
    }

    function createDownloadLink( blob, filename ) {
      var url = URL.createObjectURL( blob );

      var audio = document.createElement('audio');
      audio.controls = true;
      audio.src = url;

      var link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.innerHTML = link.download;

      var li = document.createElement('li');
      li.appendChild(link);
      li.appendChild(audio);

      recordingslist.appendChild(li);
    }

    function screenLogger(text, data) {
      log.innerHTML += "\n" + text + " " + (data || '');
    }
  </script>
</body>
</html>