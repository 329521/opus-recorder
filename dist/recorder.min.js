!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Recorder=e():t.Recorder=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function i(o){if(e[o])return e[o].exports;var n=e[o]={i:o,l:!1,exports:{}};return t[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,o){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(o,n,function(e){return t[e]}.bind(null,n));return o},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";(function(e){var i=e.AudioContext||e.webkitAudioContext,o=function(t){if(!o.isRecordingSupported())throw new Error("Recording is not supported in this browser");t||(t={}),this.state="inactive",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:"encoderWorker.min.js",encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,wavBitDepth:16},t)};o.isRecordingSupported=function(){return i&&e.navigator&&e.navigator.mediaDevices&&e.navigator.mediaDevices.getUserMedia&&e.WebAssembly},o.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(function(t){t.stop()}):this.stream.stop(),delete this.stream),this.audioContext&&this.closeAudioContext&&(this.audioContext.close(),delete this.audioContext)},o.prototype.encodeBuffers=function(t){if("recording"===this.state){for(var e=[],i=0;i<t.numberOfChannels;i++)e[i]=t.getChannelData(i);this.encoder.postMessage({command:"encode",buffers:e})}},o.prototype.initAudioContext=function(t){return t&&t.context?(this.audioContext=t.context,this.closeAudioContext=!1):(this.audioContext=new i,this.closeAudioContext=!0),this.audioContext},o.prototype.initAudioGraph=function(){this.encodeBuffers=function(){delete this.encodeBuffers},this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.connect(this.audioContext.destination),this.scriptProcessorNode.onaudioprocess=(t=>{this.encodeBuffers(t.inputBuffer)}),this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain),this.recordingGainNode.connect(this.scriptProcessorNode)},o.prototype.initSourceNode=function(t){return t&&t.context?e.Promise.resolve(t):e.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(t=>(this.stream=t,this.audioContext.createMediaStreamSource(t)))},o.prototype.initWorker=function(){var t=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,this.encoder=new e.Worker(this.config.encoderPath),new Promise((e,i)=>{this.encoder.addEventListener("message",i=>{switch(i.data.message){case"ready":e();break;case"page":t(i.data.page);break;case"done":this.finish()}}),this.encoder.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config))})},o.prototype.pause=function(t){if("recording"===this.state)return this.state="paused",t&&this.config.streamPages?new Promise((t,e)=>{const i=e=>{"flushed"===e.data.message&&(this.encoder.removeEventListener("message",i),this.onpause(),t())};this.encoder.addEventListener("message",i),this.encoder.postMessage({command:"flush"})}):(this.onpause(),Promise.resolve())},o.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.onresume())},o.prototype.setRecordingGain=function(t){this.config.recordingGain=t,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(t,this.audioContext.currentTime,.01)},o.prototype.setMonitorGain=function(t){this.config.monitorGain=t,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(t,this.audioContext.currentTime,.01)},o.prototype.start=function(t){if("inactive"===this.state)return this.initAudioContext(t),this.initAudioGraph(),Promise.all([this.initSourceNode(t),this.initWorker()]).then(t=>{this.sourceNode=t[0],this.state="recording",this.sourceNode.connect(this.monitorGainNode),this.sourceNode.connect(this.recordingGainNode),this.onstart()})},o.prototype.stop=function(){return"inactive"!==this.state?(this.state="inactive",this.monitorGainNode.disconnect(),this.scriptProcessorNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode.disconnect(),this.clearStream(),this.encoder.postMessage({command:"done"}),new Promise(t=>{this._finished=t})):Promise.resolve()},o.prototype.storePage=function(t){this.recordedPages.push(t),this.totalLength+=t.length},o.prototype.streamPage=function(t){this.ondataavailable(t)},o.prototype.finish=function(){if(!this.config.streamPages){var t=new Uint8Array(this.totalLength);this.recordedPages.reduce(function(e,i){return t.set(i,e),e+i.length},0),this.ondataavailable(t)}this.onstop(),this._finished&&(this._finished(),delete this._finished)},o.prototype.ondataavailable=function(){},o.prototype.onpause=function(){},o.prototype.onresume=function(){},o.prototype.onstart=function(){},o.prototype.onstop=function(){},t.exports=o}).call(this,i(1))},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(i=window)}t.exports=i}])});