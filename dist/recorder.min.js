"use strict";var root="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;!function(e){var t=e.AudioContext||e.webkitAudioContext,o=e.navigator&&(e.navigator.getUserMedia||e.navigator.webkitGetUserMedia||e.navigator.mozGetUserMedia),n=function(o){var i=this;if(!n.isRecordingSupported())throw new Error("Recording is not supported in this browser");this.state="inactive",this.eventTarget=e.document.createDocumentFragment(),this.audioContext=new t,this.monitorNode=this.audioContext.createGain(),this.config=o=o||{},this.config.command="init",this.config.bufferLength=o.bufferLength||4096,this.config.monitorGain=o.monitorGain||0,this.config.numberOfChannels=o.numberOfChannels||1,this.config.originalSampleRate=this.audioContext.sampleRate,this.config.encoderSampleRate=o.encoderSampleRate||48e3,this.config.encoderPath=o.encoderPath||"encoderWorker.min.js",this.config.streamPages=o.streamPages||!1,this.config.leaveStreamOpen=o.leaveStreamOpen||!1,this.config.maxBuffersPerPage=o.maxBuffersPerPage||40,this.config.encoderApplication=o.encoderApplication||2049,this.config.encoderFrameSize=o.encoderFrameSize||20,this.config.resampleQuality=o.resampleQuality||3,this.config.streamOptions=o.streamOptions||{optional:[],mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1}},this.setMonitorGain(this.config.monitorGain),this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.onaudioprocess=function(e){i.encodeBuffers(e.inputBuffer)}};n.isRecordingSupported=function(){return t&&o},n.prototype.addEventListener=function(e,t,o){this.eventTarget.addEventListener(e,t,o)},n.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(function(e){e.stop()}):this.stream.stop(),delete this.stream)},n.prototype.encodeBuffers=function(e){if("recording"===this.state){for(var t=[],o=0;o<e.numberOfChannels;o++)t[o]=e.getChannelData(o);this.encoder.postMessage({command:"encode",buffers:t})}},n.prototype.initStream=function(){if(this.stream)return void this.eventTarget.dispatchEvent(new e.Event("streamReady"));var t=this;e.navigator.getUserMedia({audio:this.config.streamOptions},function(o){t.stream=o,t.sourceNode=t.audioContext.createMediaStreamSource(o),t.sourceNode.connect(t.scriptProcessorNode),t.sourceNode.connect(t.monitorNode),t.eventTarget.dispatchEvent(new e.Event("streamReady"))},function(o){t.eventTarget.dispatchEvent(new e.ErrorEvent("streamError",{error:o}))})},n.prototype.pause=function(){"recording"===this.state&&(this.state="paused",this.eventTarget.dispatchEvent(new e.Event("pause")))},n.prototype.removeEventListener=function(e,t,o){this.eventTarget.removeEventListener(e,t,o)},n.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.eventTarget.dispatchEvent(new e.Event("resume")))},n.prototype.setMonitorGain=function(e){this.monitorNode.gain.value=e},n.prototype.start=function(){if("inactive"===this.state&&this.stream){var t=this;this.encoder=new e.Worker(this.config.encoderPath),this.config.streamPages?this.encoder.addEventListener("message",function(e){t.streamPage(e.data)}):(this.recordedPages=[],this.totalLength=0,this.encoder.addEventListener("message",function(e){t.storePage(e.data)})),this.encodeBuffers=function(){delete this.encodeBuffers},this.state="recording",this.monitorNode.connect(this.audioContext.destination),this.scriptProcessorNode.connect(this.audioContext.destination),this.eventTarget.dispatchEvent(new e.Event("start")),this.encoder.postMessage(this.config)}},n.prototype.stop=function(){"inactive"!==this.state&&(this.state="inactive",this.monitorNode.disconnect(),this.scriptProcessorNode.disconnect(),this.config.leaveStreamOpen||this.clearStream(),this.encoder.postMessage({command:"done"}))},n.prototype.storePage=function(t){if(null===t){for(var o=new Uint8Array(this.totalLength),n=0,i=0;i<this.recordedPages.length;i++)o.set(this.recordedPages[i],n),n+=this.recordedPages[i].length;this.eventTarget.dispatchEvent(new e.CustomEvent("dataAvailable",{detail:o})),this.recordedPages=[],this.eventTarget.dispatchEvent(new e.Event("stop"))}else this.recordedPages.push(t),this.totalLength+=t.length},n.prototype.streamPage=function(t){null===t?this.eventTarget.dispatchEvent(new e.Event("stop")):this.eventTarget.dispatchEvent(new e.CustomEvent("dataAvailable",{detail:t}))},e.Recorder=n,"function"==typeof define&&define.amd?define([],function(){return n}):"object"==typeof module&&module.exports&&(module.exports=n)}(root);